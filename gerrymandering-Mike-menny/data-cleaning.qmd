---
title: Data Cleaning
format: typst
---

```{r}
library(tidyverse)

b <- read.csv("gerrymandering-Mike-menny/data/g24_sov_by_g24_svprec.csv")

numeric_cols <- names(b)[which(names(b) == "TOTREG"):which(names(b) == "USSREP01")]

b_cleaned_aggregated <- b %>%
  mutate(base_precinct_key = str_remove(SVPREC_KEY, "[A-Z]+$")) %>%
  
  # This one line replaces the two original mutate steps.
  # It forces non-numeric values (like "*") to NA.
  # You can wrap this in suppressWarnings() to hide the "NAs introduced" message.
  mutate(across(all_of(numeric_cols), ~ as.numeric(.))) %>%
  
  group_by(base_precinct_key) %>%
  summarise(
    across(all_of(numeric_cols), ~ sum(., na.rm = TRUE)),
    COUNTY = first(COUNTY),
    FIPS = first(FIPS),
    ADDIST = first(ADDIST),
    CDDIST = first(CDDIST),
    SDDIST = first(SDDIST),
    BEDIST = first(BEDIST)
  )

write.csv(
  b_cleaned_aggregated, 
  "gerrymandering-Mike-menny/data/g24_precinct_vote_data_cleaned.csv", 
  row.names = FALSE
)

library(sf)
library(tidyverse)

srprec_votes <- read.csv("gerrymandering-Mike-menny/data/state_g24_sov_data_by_g24_srprec.csv")

srprec_shp <- st_read("gerrymandering-Mike-menny/data/shapefiles/srprec_state_g24_v01_shp.shp")

# 1c. Load the new AB 604 (proposed) district map
ab604_shp <- st_read("gerrymandering-Mike-menny/data/shapefiles/AB604.shp")

sr_numeric_cols <- names(srprec_votes)[which(names(srprec_votes) == "TOTREG"):ncol(srprec_votes)]
srprec_votes_cleaned <- srprec_votes %>%
  # Create the base key to merge 'A' rows
  mutate(base_precinct_key = str_remove(SRPREC_KEY, "[A-Z]+$")) %>%
  
  # Convert all vote columns to numeric, turning '*' into NA
  mutate(across(all_of(sr_numeric_cols), ~ as.numeric(as.character(.)))) %>%
  
  # Group and summarise to combine the 'A' rows
  group_by(base_precinct_key) %>%
  summarise(
    across(all_of(sr_numeric_cols), ~ sum(., na.rm = TRUE)),
    # We also need the congressional votes for the analysis
    Total_D_Votes = sum(CNGDEM01, CNGDEM02, na.rm = TRUE),
    Total_R_Votes = sum(CNGREP01, CNGREP02, na.rm = TRUE)
  )

srprec_shp_clean <- srprec_shp %>%
  st_transform(3310) %>%          # Use CRS 3310 (California Albers)
  st_set_precision(1) %>%         # Snap points to 1m grid
  st_make_valid() %>%             # Fix self-intersections
  st_collection_extract("POLYGON")

ab604_shp_clean <- ab604_shp %>%
  st_transform(3310) %>%          # Use the same CRS
  st_set_precision(1) %>%
  st_make_valid() %>%
  st_collection_extract("POLYGON")
# --- D: Join Votes to Precinct Map ---
srprec_with_votes <- srprec_shp_clean %>%
  # Check your shapefile columns (e.g., 'names(srprec_shp_clean)')
  # to confirm the key is 'SRPREC_KEY'
  left_join(srprec_votes_cleaned, by = c("SRPREC_KEY" = "base_precinct_key")) %>%
  # Select only the columns we need for the interpolation
  select(
    Total_D_Votes, Total_R_Votes,
    geometry # sf geometry column
  )

# --- E: Perform Area-Weighted Interpolation ---

# 5a. Add a unique ID to the precincts BEFORE intersection
# This lets us group the "pieces" back together after cutting them up.
srprec_with_votes <- srprec_with_votes %>%
  mutate(orig_precinct_id = row_number())
  
# 5b. Calculate the intersection
# This "cuts" the precincts up using the new district lines
# and creates a new, smaller polygon for every intersection
intersection <- st_intersection(srprec_with_votes, ab604_shp_clean)

# 5c. Calculate the new vote proportions for each "piece"
intersection_with_votes <- intersection %>%
  # Calculate the area of each new "cut-up" piece
  mutate(piece_area = st_area(.)) %>%
  # Group by the original precinct ID
  group_by(orig_precinct_id) %>%
  # Calculate the total area of the original precinct
  mutate(orig_precinct_area = sum(piece_area, na.rm = TRUE)) %>%
  # Calculate the proportion of the precinct's area this piece represents
  # Use 0 if orig_precinct_area is 0 to avoid division by zero
  mutate(area_proportion = if_else(orig_precinct_area == 0, 0, 
                                 as.numeric(piece_area / orig_precinct_area))) %>%
  
  # 5d. Allocate votes based on area proportion
  mutate(
    Est_D_Votes = Total_D_Votes * area_proportion,
    Est_R_Votes = Total_R_Votes * area_proportion
  )

# --- F: Tally Votes for New Districts ---

new_district_votes_2024 <- intersection_with_votes %>%
  # Group by the new district ID
  st_drop_geometry() %>% # Drop geometry, we just need numbers now
  group_by(CONDIST) %>%  # This 'CONDIST' column comes from the AB604 shapefile
  summarise(
    Total_D_Votes = sum(Est_D_Votes, na.rm = TRUE),
    Total_R_Votes = sum(Est_R_Votes, na.rm = TRUE)
  )

write.csv(
  new_district_votes_2024, 
  "gerrymandering-Mike-menny/data/g24_rerun_votes_by_ab604.csv", 
  row.names = FALSE
)

print("Successfully re-run 2024 election on new AB 604 map.")
```